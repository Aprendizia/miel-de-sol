<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= title %> | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="/assets/icon/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <%- include('../partials/admin-styles') %>
</head>
<body>
    <%- include('../partials/admin-sidebar', { activePage: 'inventory' }) %>

    <div class="main-content">
        <%- include('../partials/admin-header', { title: 'Inventario' }) %>

        <!-- Summary Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <h3><%= summary.total_products %></h3>
                    <small class="text-muted">Productos</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <h3><%= summary.total_units.toLocaleString() %></h3>
                    <small class="text-muted">Unidades</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <h3 class="text-warning"><%= summary.low_stock %></h3>
                    <small class="text-muted">Stock Bajo</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <h3 class="text-danger"><%= summary.out_of_stock %></h3>
                    <small class="text-muted">Sin Stock</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted">Valor de Inventario</small>
                            <h3>$<%= summary.total_value.toLocaleString('es-MX') %></h3>
                            <small class="text-success">Valor retail: $<%= summary.retail_value.toLocaleString('es-MX') %></small>
                        </div>
                        <div class="icon" style="background: rgba(244,167,0,0.1); color: #F4A700;">
                            <i class="fas fa-warehouse"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Alerts Section -->
            <div class="col-lg-4">
                <div class="table-card h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Alertas
                        </h5>
                        <span class="badge bg-danger"><%= lowStock.length + outOfStock.length %></span>
                    </div>

                    <% const supabaseImg = 'https://gmlfpzdenaholmviiyxl.supabase.co/storage/v1/object/public/images'; %>
                    <% const defaultProductImg = supabaseImg + '/products/product-1.png'; %>
                    
                    <% if (outOfStock.length > 0) { %>
                    <div class="mb-4">
                        <h6 class="text-danger mb-3"><i class="fas fa-times-circle me-2"></i>Sin Stock (<%= outOfStock.length %>)</h6>
                        <% outOfStock.slice(0, 5).forEach(product => { %>
                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom" style="border-color: var(--admin-border) !important;">
                            <div class="d-flex align-items-center">
                                <img src="<%= product.image_url || defaultProductImg %>" 
                                     class="product-img me-2" style="width: 36px; height: 36px;">
                                <span class="small"><%= product.name %></span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary adjust-stock-btn" 
                                    data-product-id="<%= product.id %>"
                                    data-product-name="<%= product.name %>"
                                    data-stock="0">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>

                    <% if (lowStock.length > 0) { %>
                    <div>
                        <h6 class="text-warning mb-3"><i class="fas fa-exclamation-circle me-2"></i>Stock Bajo (<%= lowStock.length %>)</h6>
                        <% lowStock.slice(0, 5).forEach(product => { %>
                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom" style="border-color: var(--admin-border) !important;">
                            <div class="d-flex align-items-center">
                                <img src="<%= product.image_url || defaultProductImg %>" 
                                     class="product-img me-2" style="width: 36px; height: 36px;">
                                <div>
                                    <span class="small d-block"><%= product.name %></span>
                                    <span class="badge bg-warning"><%= product.stock_quantity %> uds</span>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary adjust-stock-btn"
                                    data-product-id="<%= product.id %>"
                                    data-product-name="<%= product.name %>"
                                    data-stock="<%= product.stock_quantity %>">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>

                    <% if (outOfStock.length === 0 && lowStock.length === 0) { %>
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-success mb-2" style="font-size: 2.5rem;"></i>
                        <p class="text-muted mb-0">Todo el inventario est谩 OK</p>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Valuation by Category -->
            <div class="col-lg-4">
                <div class="table-card h-100">
                    <h5 class="mb-4">
                        <i class="fas fa-chart-pie text-info me-2"></i>
                        Valor por Categor铆a
                    </h5>
                    <canvas id="valuationChart" height="200"></canvas>
                    
                    <div class="mt-3">
                        <% valuation.by_category.forEach(cat => { %>
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--admin-border) !important;">
                            <span class="small"><%= cat.category %></span>
                            <div class="text-end">
                                <span class="small text-muted"><%= cat.units %> uds</span>
                                <br>
                                <strong class="small">$<%= cat.retail_value.toLocaleString('es-MX') %></strong>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>

            <!-- Stock Projection -->
            <div class="col-lg-4">
                <div class="table-card h-100">
                    <h5 class="mb-4">
                        <i class="fas fa-clock text-danger me-2"></i>
                        Riesgo de Agotamiento (7 d铆as)
                    </h5>
                    
                    <% if (projection.length > 0) { %>
                        <% projection.forEach(product => { %>
                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom" style="border-color: var(--admin-border) !important;">
                            <div>
                                <span class="small d-block"><%= product.name %></span>
                                <small class="text-muted">
                                    <%= product.current_stock %> uds 路 ~<%= product.avg_daily_sales %> ventas/d铆a
                                </small>
                            </div>
                            <span class="badge bg-<%= product.days_until_stockout <= 3 ? 'danger' : 'warning' %>">
                                <%= product.days_until_stockout %> d铆as
                            </span>
                        </div>
                        <% }) %>
                    <% } else { %>
                    <div class="text-center py-4">
                        <i class="fas fa-shield-check text-success mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0">Sin riesgo de agotamiento pr贸ximo</p>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Recent Movements -->
        <div class="row g-4 mt-2">
            <div class="col-12">
                <div class="table-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">
                            <i class="fas fa-history text-secondary me-2"></i>
                            Movimientos Recientes
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#adjustModal">
                                <i class="fas fa-plus me-2"></i>Ajuste de Stock
                            </button>
                            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bulkModal">
                                <i class="fas fa-file-upload me-2"></i>Ajuste Masivo
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Producto</th>
                                    <th>Tipo</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-center">Anterior</th>
                                    <th class="text-center">Nuevo</th>
                                    <th>Notas</th>
                                    <th>Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% movements.forEach(mov => { %>
                                <tr>
                                    <td>
                                        <small><%= new Date(mov.created_at).toLocaleDateString('es-MX') %></small>
                                        <br>
                                        <small class="text-muted"><%= new Date(mov.created_at).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }) %></small>
                                    </td>
                                    <td><%= mov.product_name || mov.products?.name %></td>
                                    <td>
                                        <span class="badge bg-<%= movementTypes[mov.movement_type]?.color || 'secondary' %>">
                                            <%= movementTypes[mov.movement_type]?.icon || '' %>
                                            <%= movementTypes[mov.movement_type]?.name || mov.movement_type %>
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="<%= mov.quantity > 0 ? 'text-success' : 'text-danger' %>">
                                            <%= mov.quantity > 0 ? '+' : '' %><%= mov.quantity %>
                                        </span>
                                    </td>
                                    <td class="text-center text-muted"><%= mov.previous_stock %></td>
                                    <td class="text-center"><strong><%= mov.new_stock %></strong></td>
                                    <td><small class="text-muted"><%= mov.notes || '-' %></small></td>
                                    <td><small><%= mov.created_by_name || mov.profiles?.full_name || 'Sistema' %></small></td>
                                </tr>
                                <% }) %>
                                <% if (movements.length === 0) { %>
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        No hay movimientos registrados
                                    </td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Stock Modal -->
    <div class="modal fade" id="adjustModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/admin/inventory/adjust" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Producto *</label>
                            <select name="product_id" class="form-select" required id="adjustProductSelect">
                                <option value="">Seleccionar producto</option>
                                <% products.forEach(p => { %>
                                <option value="<%= p.id %>" data-stock="<%= p.stock_quantity %>"><%= p.name %> (Stock: <%= p.stock_quantity %>)</option>
                                <% }) %>
                            </select>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label class="form-label">Tipo de Movimiento *</label>
                                <select name="type" class="form-select" required>
                                    <option value="purchase"> Compra/Entrada</option>
                                    <option value="adjustment"> Ajuste Manual</option>
                                    <option value="return">╋ Devoluci贸n</option>
                                    <option value="damage"> Da帽o/Merma</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Cantidad *</label>
                                <input type="number" name="quantity" class="form-control" required placeholder="+50 o -10">
                                <small class="text-muted">Positivo = entrada, Negativo = salida</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea name="notes" class="form-control" rows="2" placeholder="Motivo del ajuste..."></textarea>
                        </div>
                        
                        <div class="alert alert-info mb-0">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Stock actual: <strong id="currentStockDisplay">-</strong>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Ajuste
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Adjust Modal -->
    <div class="modal fade" id="bulkModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste Masivo de Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/admin/inventory/bulk-adjust" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Ingresa los ajustes en formato: <code>SKU, cantidad</code> (uno por l铆nea)
                            <br>
                            Ejemplo: <code>MIEL-001, +50</code> o <code>PROP-001, -5</code>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Movimiento *</label>
                            <select name="type" class="form-select" required>
                                <option value="purchase"> Compra/Entrada</option>
                                <option value="adjustment"> Ajuste Manual</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ajustes (SKU, cantidad) *</label>
                            <textarea name="adjustments_text" class="form-control font-mono" rows="10" required placeholder="MIEL-001, +50
PROP-001, -5
JAL-001, +20"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <input type="text" name="notes" class="form-control" placeholder="Ej: Reposici贸n de inventario enero">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Procesar Ajustes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('../partials/admin-scripts') %>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data from server (<%- outputs raw, unescaped JSON)
        var valuationData = <%- JSON.stringify(valuation && valuation.by_category ? valuation.by_category : []) %>;
        
        // Valuation Chart
        var chartCanvas = document.getElementById('valuationChart');
        if (chartCanvas && valuationData.length > 0) {
            new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: valuationData.map(function(c) { return c.category; }),
                    datasets: [{
                        data: valuationData.map(function(c) { return c.retail_value; }),
                        backgroundColor: [
                            'rgba(244, 167, 0, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(168, 85, 247, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        } else if (chartCanvas) {
            chartCanvas.parentElement.innerHTML = '<p class="text-muted text-center py-4">Sin datos de valuaci贸n</p>';
        }
        
        // Product select handler
        var adjustProductSelect = document.getElementById('adjustProductSelect');
        var currentStockDisplay = document.getElementById('currentStockDisplay');
        
        if (adjustProductSelect) {
            adjustProductSelect.addEventListener('change', function() {
                var option = this.options[this.selectedIndex];
                if (currentStockDisplay) {
                    currentStockDisplay.textContent = option.dataset.stock || '-';
                }
            });
        }
        
        // Adjust stock buttons (replaces inline onclick)
        var adjustButtons = document.querySelectorAll('.adjust-stock-btn');
        adjustButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var productId = this.getAttribute('data-product-id');
                var productName = this.getAttribute('data-product-name');
                var currentStock = this.getAttribute('data-stock');
                
                // Set select value
                if (adjustProductSelect) {
                    adjustProductSelect.value = productId;
                }
                
                // Update stock display
                if (currentStockDisplay) {
                    currentStockDisplay.textContent = currentStock;
                }
                
                // Show modal
                var modal = new bootstrap.Modal(document.getElementById('adjustModal'));
                modal.show();
            });
        });
    });
    </script>
</body>
</html>
