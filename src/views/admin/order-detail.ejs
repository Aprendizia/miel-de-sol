<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= title %> | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçØ</text></svg>">
    <%- include('../partials/admin-styles') %>
</head>
<body>
    <%- include('../partials/admin-sidebar', { activePage: 'orders' }) %>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="/admin/orders" class="text-muted text-decoration-none mb-2 d-inline-block">
                    <i class="fas fa-arrow-left me-1"></i> Volver a pedidos
                </a>
                <h2 class="mb-0">Pedido #<%= order.order_number %></h2>
            </div>
            <div>
                <span class="badge bg-<%= 
                    order.status === 'delivered' ? 'success' : 
                    order.status === 'shipped' ? 'info' : 
                    order.status === 'processing' ? 'primary' :
                    order.status === 'cancelled' ? 'danger' : 'warning' 
                %> fs-6">
                    <%= order.status === 'pending' ? 'Pendiente' :
                        order.status === 'confirmed' ? 'Confirmado' :
                        order.status === 'processing' ? 'Procesando' :
                        order.status === 'shipped' ? 'Enviado' :
                        order.status === 'delivered' ? 'Entregado' :
                        order.status === 'cancelled' ? 'Cancelado' : order.status %>
                </span>
                <span class="badge bg-<%= order.payment_status === 'paid' ? 'success' : 'warning' %> fs-6 ms-2">
                    <%= order.payment_status === 'paid' ? 'Pagado' : 'Pago Pendiente' %>
                </span>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Order Items -->
                <div class="table-card mb-4">
                    <h5 class="mb-4"><i class="fas fa-box me-2"></i>Productos</h5>
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orderItems.forEach(item => { %>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="<%= item.product_image || '/assets/img/products/product-1.png' %>" 
                                                 alt="<%= item.product_name %>"
                                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"
                                                 class="me-3">
                                            <div>
                                                <strong><%= item.product_name %></strong>
                                                <% if (item.product_sku) { %>
                                                <br><small class="text-muted">SKU: <%= item.product_sku %></small>
                                                <% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center"><%= item.quantity %></td>
                                    <td class="text-end">$<%= parseFloat(item.unit_price).toFixed(2) %></td>
                                    <td class="text-end"><strong>$<%= parseFloat(item.total_price).toFixed(2) %></strong></td>
                                </tr>
                                <% }) %>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end">Subtotal:</td>
                                    <td class="text-end">$<%= parseFloat(order.subtotal).toFixed(2) %></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">Env√≠o:</td>
                                    <td class="text-end">$<%= parseFloat(order.shipping_cost || 0).toFixed(2) %></td>
                                </tr>
                                <tr class="fw-bold">
                                    <td colspan="3" class="text-end">Total:</td>
                                    <td class="text-end fs-5">$<%= parseFloat(order.total).toFixed(2) %></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Update Status Form -->
                <div class="table-card">
                    <h5 class="mb-4"><i class="fas fa-edit me-2"></i>Actualizar Pedido</h5>
                    
                    <form action="/admin/orders/<%= order.id %>/update" method="POST">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Estado del Pedido</label>
                                <select name="status" class="form-select">
                                    <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>‚è≥ Pendiente</option>
                                    <option value="confirmed" <%= order.status === 'confirmed' ? 'selected' : '' %>>‚úì Confirmado</option>
                                    <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>‚öôÔ∏è Procesando</option>
                                    <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>üöö Enviado</option>
                                    <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>‚úÖ Entregado</option>
                                    <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>‚ùå Cancelado</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Estado del Pago</label>
                                <select name="payment_status" class="form-select">
                                    <option value="pending" <%= order.payment_status === 'pending' ? 'selected' : '' %>>Pendiente</option>
                                    <option value="paid" <%= order.payment_status === 'paid' ? 'selected' : '' %>>Pagado</option>
                                    <option value="failed" <%= order.payment_status === 'failed' ? 'selected' : '' %>>Fallido</option>
                                    <option value="refunded" <%= order.payment_status === 'refunded' ? 'selected' : '' %>>Reembolsado</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">N√∫mero de Tracking</label>
                                <input type="text" name="tracking_number" class="form-control" 
                                       value="<%= order.tracking_number || '' %>"
                                       placeholder="Ej: MX123456789">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">URL de Rastreo</label>
                                <input type="url" name="tracking_url" class="form-control" 
                                       value="<%= order.tracking_url || '' %>"
                                       placeholder="https://...">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Notas Internas</label>
                                <textarea name="admin_notes" class="form-control" rows="3"
                                          placeholder="Notas visibles solo para administradores"><%= order.admin_notes || '' %></textarea>
                            </div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- Customer Info -->
                <div class="table-card mb-4">
                    <h5 class="mb-3"><i class="fas fa-user me-2"></i>Cliente</h5>
                    <p class="mb-1"><strong><%= order.customer_name %></strong></p>
                    <p class="mb-1"><a href="mailto:<%= order.customer_email %>"><%= order.customer_email %></a></p>
                    <% if (order.customer_phone) { %>
                    <p class="mb-0"><a href="tel:<%= order.customer_phone %>"><%= order.customer_phone %></a></p>
                    <% } %>
                </div>

                <!-- Shipping Address -->
                <div class="table-card mb-4">
                    <h5 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>Direcci√≥n de Env√≠o</h5>
                    <% 
                    const addr = typeof order.shipping_address === 'string' 
                        ? JSON.parse(order.shipping_address) 
                        : order.shipping_address;
                    %>
                    <p class="mb-1"><%= addr.street %></p>
                    <p class="mb-1"><%= addr.city %>, <%= addr.state %></p>
                    <p class="mb-1">CP: <%= addr.postal_code %></p>
                    <p class="mb-0"><%= addr.country || 'M√©xico' %></p>
                </div>

                <!-- Payment Info -->
                <div class="table-card mb-4">
                    <h5 class="mb-3"><i class="fas fa-credit-card me-2"></i>Pago</h5>
                    <p class="mb-1">
                        <strong>M√©todo:</strong> 
                        <%= order.payment_method === 'stripe' ? 'Tarjeta (Stripe)' : 
                            order.payment_method === 'transfer' ? 'Transferencia' : 
                            order.payment_method || 'No especificado' %>
                    </p>
                    <% if (order.payment_id) { %>
                    <p class="mb-0">
                        <strong>ID:</strong> 
                        <small class="text-muted"><%= order.payment_id %></small>
                    </p>
                    <% } %>
                </div>

                <!-- Dates -->
                <div class="table-card mb-4">
                    <h5 class="mb-3"><i class="fas fa-calendar me-2"></i>Fechas</h5>
                    <p class="mb-1">
                        <strong>Creado:</strong> 
                        <%= new Date(order.created_at).toLocaleString('es-MX') %>
                    </p>
                    <% if (order.shipped_at) { %>
                    <p class="mb-1">
                        <strong>Enviado:</strong> 
                        <%= new Date(order.shipped_at).toLocaleString('es-MX') %>
                    </p>
                    <% } %>
                    <% if (order.delivered_at) { %>
                    <p class="mb-0">
                        <strong>Entregado:</strong> 
                        <%= new Date(order.delivered_at).toLocaleString('es-MX') %>
                    </p>
                    <% } %>
                </div>

                <!-- Customer Notes -->
                <% if (order.customer_notes) { %>
                <div class="table-card">
                    <h5 class="mb-3"><i class="fas fa-comment me-2"></i>Notas del Cliente</h5>
                    <p class="mb-0 text-muted"><%= order.customer_notes %></p>
                </div>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('../partials/admin-scripts') %>
</body>
</html>
