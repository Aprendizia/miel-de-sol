<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= title %> | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>游꼺</text></svg>">
    <%- include('../partials/admin-styles') %>
</head>
<body>
    <%- include('../partials/admin-sidebar', { activePage: 'coupons' }) %>

    <div class="main-content">
        <%- include('../partials/admin-header', { title: 'Cupones de Descuento' }) %>

        <div class="row g-4">
            <!-- Create Coupon Form -->
            <div class="col-lg-4">
                <div class="table-card">
                    <h5 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Nuevo Cup칩n</h5>
                    
                    <form action="/admin/coupons" method="POST">
                        <div class="mb-3">
                            <label class="form-label">C칩digo *</label>
                            <input type="text" name="code" class="form-control text-uppercase" required 
                                   placeholder="DESCUENTO20" maxlength="50">
                            <small class="text-muted">M치x 50 caracteres, sin espacios</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripci칩n</label>
                            <input type="text" name="description" class="form-control" 
                                   placeholder="20% de descuento en todo">
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">Tipo *</label>
                                <select name="discount_type" class="form-select" required id="discountType">
                                    <option value="percentage">Porcentaje (%)</option>
                                    <option value="fixed">Monto Fijo ($)</option>
                                    <option value="free_shipping">Env칤o Gratis</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Valor *</label>
                                <div class="input-group">
                                    <span class="input-group-text" id="discountPrefix">%</span>
                                    <input type="number" name="discount_value" class="form-control" 
                                           required min="0" step="0.01" id="discountValue">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">M칤nimo de Compra</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" name="minimum_amount" class="form-control" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Descuento M치ximo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" name="maximum_discount" class="form-control" 
                                           min="0" step="0.01" placeholder="Sin l칤mite">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">Usos Totales</label>
                                <input type="number" name="usage_limit" class="form-control" 
                                       min="1" placeholder="Ilimitado">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Usos por Usuario</label>
                                <input type="number" name="usage_per_user" class="form-control" 
                                       min="1" value="1">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">V치lido Hasta</label>
                            <input type="datetime-local" name="valid_until" class="form-control">
                            <small class="text-muted">Dejar vac칤o para sin expiraci칩n</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-2"></i>Crear Cup칩n
                        </button>
                    </form>
                </div>
            </div>

            <!-- Coupons List -->
            <div class="col-lg-8">
                <div class="table-card">
                    <h5 class="mb-4"><i class="fas fa-ticket-alt me-2"></i>Cupones Existentes</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>C칩digo</th>
                                    <th>Descuento</th>
                                    <th>M칤nimo</th>
                                    <th>Usos</th>
                                    <th>V치lido Hasta</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% coupons.forEach(coupon => { %>
                                <tr class="<%= !coupon.is_active ? 'table-secondary' : '' %>">
                                    <td>
                                        <strong class="font-monospace"><%= coupon.code %></strong>
                                        <% if (coupon.description) { %>
                                        <br><small class="text-muted"><%= coupon.description %></small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (coupon.discount_type === 'percentage') { %>
                                            <span class="badge bg-primary"><%= coupon.discount_value %>%</span>
                                        <% } else if (coupon.discount_type === 'fixed') { %>
                                            <span class="badge bg-success">$<%= coupon.discount_value %></span>
                                        <% } else { %>
                                            <span class="badge bg-info">游뚴 Gratis</span>
                                        <% } %>
                                    </td>
                                    <td>$<%= coupon.minimum_amount || 0 %></td>
                                    <td>
                                        <%= coupon.used_count %><% if (coupon.usage_limit) { %>/<%= coupon.usage_limit %><% } %>
                                    </td>
                                    <td>
                                        <% if (coupon.valid_until) { %>
                                            <% const isExpired = new Date(coupon.valid_until) < new Date(); %>
                                            <span class="<%= isExpired ? 'text-danger' : '' %>">
                                                <%= new Date(coupon.valid_until).toLocaleDateString('es-MX') %>
                                            </span>
                                            <% if (isExpired) { %><br><small class="text-danger">Expirado</small><% } %>
                                        <% } else { %>
                                            <span class="text-muted">Sin l칤mite</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= coupon.is_active ? 'success' : 'secondary' %>">
                                            <%= coupon.is_active ? 'Activo' : 'Inactivo' %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <form action="/admin/coupons/<%= coupon.id %>/toggle" method="POST" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-<%= coupon.is_active ? 'warning' : 'success' %>" title="<%= coupon.is_active ? 'Desactivar' : 'Activar' %>">
                                                    <i class="fas fa-<%= coupon.is_active ? 'pause' : 'play' %>"></i>
                                                </button>
                                            </form>
                                            <form action="/admin/coupons/<%= coupon.id %>/delete" method="POST" style="display: inline;" class="delete-coupon-form">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                                <% if (coupons.length === 0) { %>
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-ticket-alt text-muted mb-2" style="font-size: 2rem;"></i>
                                        <p class="text-muted mb-0">No hay cupones creados</p>
                                    </td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/admin-scripts') %>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Discount type handler
        var discountType = document.getElementById('discountType');
        var prefix = document.getElementById('discountPrefix');
        var value = document.getElementById('discountValue');
        
        if (discountType) {
            discountType.addEventListener('change', function() {
                if (this.value === 'percentage') {
                    prefix.textContent = '%';
                    value.max = 100;
                    value.disabled = false;
                } else if (this.value === 'fixed') {
                    prefix.textContent = '$';
                    value.max = '';
                    value.disabled = false;
                } else {
                    prefix.textContent = '-';
                    value.value = 0;
                    value.disabled = true;
                }
            });
        }
        
        // Delete confirmation
        var deleteForms = document.querySelectorAll('.delete-coupon-form');
        deleteForms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
                if (!confirm('쮼liminar este cup칩n?')) {
                    e.preventDefault();
                }
            });
        });
    });
    </script>
</body>
</html>
